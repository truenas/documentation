{{ if not .Page.Params.hide_toc }}
<nav class="toc-panel" style="direction: rtl; text-align: left;">
  <div class="toc-container" style="direction: ltr; padding: 1em;">
    {{ if .Page.Params.use_jump_to_buttons }}
    <b>Jump To:</b>
    <div class="jump-to-buttons" style="margin-top: 10px;">
      <!-- Jump To buttons will be populated by JavaScript -->
    </div>
    <style>
      .jump-to-button {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        margin-bottom: 8px;
        padding: 12px 16px;
        background: #1194d2;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        text-align: left;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .jump-to-button:hover {
        background: #36bdeb;
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
      }
      .jump-to-button:active {
        transform: translateY(0);
      }
      .jump-to-button .icon {
        margin-right: 10px;
        font-size: 16px;
        display: inline-block;
        width: 20px;
        height: 16px;
        text-align: center;
        flex-shrink: 0;
      }
      .jump-to-button .text {
        flex: 1;
      }
    </style>
    {{ else }}
    <b>Page Sections:</b>
    <ul class="toc-list" style="list-style: none; padding-left: 0;">
    {{ end }}
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          {{ if .Page.Params.use_jump_to_buttons }}
          var buttonsContainer = document.querySelector('.jump-to-buttons');
          
          // Use custom button configuration from front matter
          var jumpButtons = [
            {{ range .Page.Params.jump_to_buttons }}
            {
              text: "{{ .text }}",
              anchor: "{{ .anchor }}",
              icon: "{{ .icon }}"
            },
            {{ end }}
          ];
          
          
          // Create buttons with async icon loading
          jumpButtons.forEach(function(buttonConfig) {
            var jumpButton = document.createElement('button');
            jumpButton.className = 'jump-to-button';
            
            // Create icon element
            var iconSpan = document.createElement('span');
            iconSpan.className = 'icon';
            
            // Create text span
            var textSpan = document.createElement('span');
            textSpan.className = 'text';
            textSpan.textContent = buttonConfig.text;
            
            jumpButton.appendChild(iconSpan);
            jumpButton.appendChild(textSpan);
            
            // Load SVG icon directly using actual icon designs
            var iconMap = {
              // Software Status page icons
              'star': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.46,13.97L5.82,21L12,17.27Z"/></svg>',
              'account-group': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,5.5A3,3 0 0,1 15,8.5A3,3 0 0,1 12,11.5A3,3 0 0,1 9,8.5A3,3 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z"/></svg>',
              'calendar': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/></svg>',
              'timeline': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,20A7,7 0 0,1 5,13A7,7 0 0,1 12,6A7,7 0 0,1 19,13A7,7 0 0,1 12,20M19.03,7.39L20.45,5.97C20,5.46 19.55,5 19.04,4.56L17.62,6C16.07,4.74 14.12,4 12,4A9,9 0 0,0 3,13A9,9 0 0,0 12,22C17,22 21,17.97 21,13C21,10.88 20.26,8.93 19.03,7.39M11,14H13V8H11M15,1H9V3H15V1Z"/></svg>',
              'conversion-path': '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13.6,15.2c-.5,0-1-.1-1.4-.4s-.7-.7-.9-1.2h-4.1c-.9,0-1.6-.3-2.3-.9-.6-.6-.9-1.4-.9-2.3s.3-1.6.9-2.3c.6-.6,1.4-.9,2.3-.9h1.6c.4,0,.8-.2,1.1-.5s.5-.7.5-1.1-.2-.8-.5-1.1c-.3-.3-.7-.5-1.1-.5h-4.1c-.2.5-.5.9-.9,1.2s-.9.5-1.4.4c-.7,0-1.2-.2-1.7-.7-.5-.5-.7-1-.7-1.7s.2-1.2.7-1.7c.5-.5,1-.7,1.7-.7s1,.2,1.4.5.7.7.9,1.1h4.1c.9,0,1.6.3,2.3.9.6.6.9,1.4.9,2.3s-.3,1.6-.9,2.3c-.6.6-1.4.9-2.3.9h-1.6c-.4,0-.8.2-1.1.5-.3.3-.5.7-.5,1.1s.2.8.5,1.1c.3.3.7.5,1.1.5h4.1c.2-.5.5-.8.9-1.1.4-.3.9-.4,1.4-.5.7,0,1.2.2,1.7.7.5.5.7,1,.7,1.7s-.2,1.2-.7,1.7-1,.7-1.7.7M2.4,4c.2,0,.4,0,.6-.2.2-.2.2-.3.2-.6s0-.4-.2-.6-.3-.2-.6-.2-.4,0-.6.2-.2.3-.2.6c0,.2,0,.4.2.6.2.2.3.2.6.2"/></svg>',
              'download': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/></svg>',
              'file-document': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M13,9V3.5L18.5,9M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z"/></svg>',
              // Original icons
              'clipboard-text': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17,9H7V7H17M17,13H7V11H17M14,17H7V15H14M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3Z"/></svg>',
              'component-versions': '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M7.2,13.8v-5.3l-4.7-2.7v5.3l4.7,2.7ZM8.8,13.8l4.7-2.7v-5.3l-4.7,2.7v5.3ZM8,16L1,12V4L8,0l7,4v8l-7,4ZM11.1,5.3l1.5-.9-4.6-2.7-1.5.9,4.6,2.6h0ZM8,7.1l1.5-.9-4.6-2.7-1.5.9s4.6,2.7,4.6,2.7Z"/></svg>',
              'package-variant': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/></svg>',
              'update-truenas': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,15.31L23.31,12L20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31Z"/></svg>',
              'fiber-new': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11 7h6v2h-6zm0 4h6v2h-6zm0 4h6v2h-6zM7 7h2v2H7zm0 4h2v2H7zm0 4h2v2H7zM20.1 3H3.9c-.5 0-.9.4-.9.9v16.2c0 .4.4.9.9.9h16.2c.4 0 .9-.5.9-.9V3.9c0-.5-.4-.9-.9-.9z"/></svg>',
              'warning': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
              'history': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>',
              'new-releases': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>'
            };
            iconSpan.innerHTML = iconMap[buttonConfig.icon] || '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>';
            
            // Add click handler for jump buttons
            jumpButton.addEventListener('click', function(e) {
              e.preventDefault();
              
              
              // Check if this anchor matches a tab ID directly
              var allTabSources = document.querySelectorAll('#release-tab-content-source, #tab-content-source, #component-tab-content-source');
              var headerInTab = false;
              var isDirectTabMatch = false;
              
              // First check if anchor is a direct tab ID
              allTabSources.forEach(function(tabSource) {
                var tabDivs = tabSource.querySelectorAll('[data-tab-id]');
                tabDivs.forEach(function(tabDiv) {
                  if (tabDiv.getAttribute('data-tab-id') === buttonConfig.anchor) {
                    isDirectTabMatch = true;
                    headerInTab = true; // Treat as header in tab for deep linking
                  }
                });
              });
              
              // If not a direct tab match, check for headers inside tabs
              if (!isDirectTabMatch) {
                allTabSources.forEach(function(tabSource) {
                  var tabHeaders = tabSource.querySelectorAll('h2, h3, h4');
                  tabHeaders.forEach(function(tabHeader) {
                    var tabHeaderText = (tabHeader.innerText || tabHeader.textContent).trim();
                    var tabHeaderAnchor = tabHeaderText.toLowerCase()
                      .replace(/[^\w\s-]/g, '')
                      .replace(/\s+/g, '-')
                      .replace(/-+/g, '-')
                      .replace(/^-|-$/g, '');
                    
                    if (tabHeaderAnchor === buttonConfig.anchor) {
                      headerInTab = true;
                    }
                  });
                });
              }
              
              if (headerInTab) {
                // Header is in a tab - use deep linking
                window.location.hash = buttonConfig.anchor;
              } else {
                // Regular header - use normal scrolling
                var targetHeader = document.getElementById(buttonConfig.anchor);
                if (targetHeader) {
                  var headerRect = targetHeader.getBoundingClientRect();
                  var absoluteTop = headerRect.top + window.pageYOffset;
                  var offset = 150; // Same offset as deep linking
                  
                  window.scrollTo({
                    top: Math.max(0, absoluteTop - offset),
                    behavior: 'smooth'
                  });
                }
                
                // Update URL without triggering hashchange
                history.replaceState(null, null, '#' + buttonConfig.anchor);
              }
            });

            buttonsContainer.appendChild(jumpButton);
          });
          
          // Icons are now loaded locally, no need for external scanning
          
          {{ else }}
          var tocList = document.querySelector('.toc-list');
          var headers = document.querySelectorAll('.gdoc-page h2, .gdoc-page h3, .gdoc-page h4');
          
          headers.forEach(function(header) {
            // Ignore headers within <details> elements or hidden tab content
            if (!header.closest('details') && 
                !header.closest('#release-tab-content-source') && 
                !header.closest('#tab-content-source')) {
              var level = header.tagName.toLowerCase().replace('h', '');
              var text = header.innerText;
              var anchor = text.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');

              var tocItem = document.createElement('li');
              var tocLink = document.createElement('a');
              tocLink.textContent = text;
              tocLink.href = '#' + anchor;

              // Add click handler to trigger deep linking
              tocLink.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Check if this header might be in a tab box
                var allTabSources = document.querySelectorAll('#release-tab-content-source, #tab-content-source, #component-tab-content-source');
                var headerInTab = false;
                
                allTabSources.forEach(function(tabSource) {
                  var tabHeaders = tabSource.querySelectorAll('h2, h3, h4');
                  tabHeaders.forEach(function(tabHeader) {
                    var tabHeaderText = (tabHeader.innerText || tabHeader.textContent).trim();
                    var tabHeaderAnchor = tabHeaderText.toLowerCase()
                      .replace(/[^\w\s-]/g, '')
                      .replace(/\s+/g, '-')
                      .replace(/-+/g, '-')
                      .replace(/^-|-$/g, '');
                    
                    if (tabHeaderAnchor === anchor) {
                      headerInTab = true;
                    }
                  });
                });
                
                if (headerInTab) {
                  // Header is in a tab - use deep linking
                  window.location.hash = anchor;
                } else {
                  // Regular header - use normal scrolling
                  var targetHeader = document.getElementById(anchor);
                  if (targetHeader) {
                    var headerRect = targetHeader.getBoundingClientRect();
                    var absoluteTop = headerRect.top + window.pageYOffset;
                    var offset = 150; // Same offset as deep linking
                    
                    window.scrollTo({
                      top: Math.max(0, absoluteTop - offset),
                      behavior: 'smooth'
                    });
                  }
                  
                  // Update URL without triggering hashchange
                  history.replaceState(null, null, '#' + anchor);
                }
              });

              tocItem.appendChild(tocLink);
              tocList.appendChild(tocItem);
              header.id = anchor;

              tocItem.id = 'toc-' + level + '-' + anchor; // Unique ID based on header level
              tocItem.style.marginLeft = (level === '3') ? '1em' : (level === '4') ? '2em' : '0';
              tocItem.style.fontSize = (level === '3') ? '13px' : (level === '4') ? '12px' : 'inherit';
            }
          });
          {{ end }}

          var sidebarRight = document.querySelector('.sidebar-right');
          {{ if .Page.Params.use_jump_to_buttons }}
          // Always show sidebar when using jump buttons
          {{ else }}
          if (document.querySelectorAll('.toc-list li').length < 3) {
            sidebarRight.style.display = 'none';
          }
          {{ end }}
        });
      </script>
      {{ if not .Page.Params.use_jump_to_buttons }}
    </ul>
    {{ end }}
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const tocPanel = document.querySelector('.toc-panel');
          const header = document.querySelector('#TrueNASHeader');
          const sitenav = document.querySelector('#sitenav');
          const footer = document.querySelector('.container.gdoc-footer');
          const footerPadding = 20;
        
          function getOffsetBottom(el) {
            return el ? el.offsetTop + el.offsetHeight : 0;
          }
        
          function clampTocPanel() {
            const scrollY = window.scrollY || window.pageYOffset;
            const navHeight = sitenav ? sitenav.offsetHeight : 0;
            const tocHeight = tocPanel.offsetHeight;
            const footerTop = footer.getBoundingClientRect().top + window.scrollY - footerPadding;
        
            const tocBottom = scrollY + navHeight + tocHeight;
        
            if (scrollY > getOffsetBottom(header)) {
              tocPanel.style.position = 'fixed';
              tocPanel.style.top = navHeight + 'px'; // keep TOC below sticky menu
        
              if (tocBottom > footerTop) {
                const overlap = tocBottom - footerTop;
                tocPanel.style.top = `${navHeight - overlap}px`;
              }
            } else {
              tocPanel.style.position = 'absolute';
              tocPanel.style.top = '';
            }
          }
        
          window.addEventListener('scroll', clampTocPanel);
          window.addEventListener('resize', clampTocPanel);
          clampTocPanel();
        });        
      </script>                  
  </div>
</nav>
{{ end }}
