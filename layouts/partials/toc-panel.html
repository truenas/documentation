{{ if not .Page.Params.hide_toc }}
<nav class="toc-panel" style="direction: rtl; text-align: left;">
  <div class="toc-container" style="direction: ltr; padding: 1em;">
    {{ if .Page.Params.use_jump_to_buttons }}
    <b>Jump To:</b>
    <div class="jump-to-buttons" style="margin-top: 10px;">
      <!-- Jump To buttons will be populated by JavaScript -->
    </div>
    <style>
      .jump-to-button {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        margin-bottom: 8px;
        padding: 12px 16px;
        background: #1194d2;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        text-align: left;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .jump-to-button:hover {
        background: #36bdeb;
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
      }
      .jump-to-button:active {
        transform: translateY(0);
      }
      .jump-to-button .icon {
        margin-right: 10px;
        font-size: 16px;
        display: inline-block;
        width: 20px;
        height: 16px;
        text-align: center;
        flex-shrink: 0;
      }
      .jump-to-button .text {
        flex: 1;
      }
    </style>
    {{ else }}
    <b>Page Sections:</b>
    <ul class="toc-list" style="list-style: none; padding-left: 0;">
    {{ end }}
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          {{ if .Page.Params.use_jump_to_buttons }}
          var buttonsContainer = document.querySelector('.jump-to-buttons');
          
          // Use custom button configuration from front matter
          var jumpButtons = [
            {{ range .Page.Params.jump_to_buttons }}
            {
              text: "{{ .text }}",
              anchor: "{{ .anchor }}",
              icon: "{{ .icon }}"
            },
            {{ end }}
          ];
          
          // Function to load SVG icons from static directory
          function loadSVGIcon(iconName) {
            return fetch('/icons/' + iconName + '.svg')
              .then(response => response.text())
              .then(svgContent => {
                // Ensure the SVG has proper styling
                if (svgContent.includes('<svg')) {
                  return svgContent.replace('<svg', '<svg style="width: 16px; height: 16px;"');
                }
                return svgContent;
              })
              .catch(error => {
                console.warn('Failed to load icon:', iconName, error);
                return '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>';
              });
          }
          
          // Create buttons with async icon loading
          jumpButtons.forEach(function(buttonConfig) {
            var jumpButton = document.createElement('button');
            jumpButton.className = 'jump-to-button';
            
            // Create icon element
            var iconSpan = document.createElement('span');
            iconSpan.className = 'icon';
            
            // Create text span
            var textSpan = document.createElement('span');
            textSpan.className = 'text';
            textSpan.textContent = buttonConfig.text;
            
            jumpButton.appendChild(iconSpan);
            jumpButton.appendChild(textSpan);
            
            // Load SVG icon asynchronously
            loadSVGIcon(buttonConfig.icon).then(function(svgContent) {
              iconSpan.innerHTML = svgContent;
            });
            
            // Add click handler for jump buttons
            jumpButton.addEventListener('click', function(e) {
              e.preventDefault();
              
              // Check if this header might be in a tab box
              var allTabSources = document.querySelectorAll('#release-tab-content-source, #tab-content-source');
              var headerInTab = false;
              
              allTabSources.forEach(function(tabSource) {
                var tabHeaders = tabSource.querySelectorAll('h2, h3, h4');
                tabHeaders.forEach(function(tabHeader) {
                  var tabHeaderText = (tabHeader.innerText || tabHeader.textContent).trim();
                  var tabHeaderAnchor = tabHeaderText.toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-|-$/g, '');
                  
                  if (tabHeaderAnchor === buttonConfig.anchor) {
                    headerInTab = true;
                  }
                });
              });
              
              if (headerInTab) {
                // Header is in a tab - use deep linking
                window.location.hash = buttonConfig.anchor;
              } else {
                // Regular header - use normal scrolling
                var targetHeader = document.getElementById(buttonConfig.anchor);
                if (targetHeader) {
                  var headerRect = targetHeader.getBoundingClientRect();
                  var absoluteTop = headerRect.top + window.pageYOffset;
                  var offset = 150; // Same offset as deep linking
                  
                  window.scrollTo({
                    top: Math.max(0, absoluteTop - offset),
                    behavior: 'smooth'
                  });
                }
                
                // Update URL without triggering hashchange
                history.replaceState(null, null, '#' + buttonConfig.anchor);
              }
            });

            buttonsContainer.appendChild(jumpButton);
          });
          
          // Icons are now loaded locally, no need for external scanning
          
          {{ else }}
          var tocList = document.querySelector('.toc-list');
          var headers = document.querySelectorAll('.gdoc-page h2, .gdoc-page h3, .gdoc-page h4');
          
          headers.forEach(function(header) {
            // Ignore headers within <details> elements or hidden tab content
            if (!header.closest('details') && 
                !header.closest('#release-tab-content-source') && 
                !header.closest('#tab-content-source')) {
              var level = header.tagName.toLowerCase().replace('h', '');
              var text = header.innerText;
              var anchor = text.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');

              var tocItem = document.createElement('li');
              var tocLink = document.createElement('a');
              tocLink.textContent = text;
              tocLink.href = '#' + anchor;

              // Add click handler to trigger deep linking
              tocLink.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Check if this header might be in a tab box
                var allTabSources = document.querySelectorAll('#release-tab-content-source, #tab-content-source');
                var headerInTab = false;
                
                allTabSources.forEach(function(tabSource) {
                  var tabHeaders = tabSource.querySelectorAll('h2, h3, h4');
                  tabHeaders.forEach(function(tabHeader) {
                    var tabHeaderText = (tabHeader.innerText || tabHeader.textContent).trim();
                    var tabHeaderAnchor = tabHeaderText.toLowerCase()
                      .replace(/[^\w\s-]/g, '')
                      .replace(/\s+/g, '-')
                      .replace(/-+/g, '-')
                      .replace(/^-|-$/g, '');
                    
                    if (tabHeaderAnchor === anchor) {
                      headerInTab = true;
                    }
                  });
                });
                
                if (headerInTab) {
                  // Header is in a tab - use deep linking
                  window.location.hash = anchor;
                } else {
                  // Regular header - use normal scrolling
                  var targetHeader = document.getElementById(anchor);
                  if (targetHeader) {
                    var headerRect = targetHeader.getBoundingClientRect();
                    var absoluteTop = headerRect.top + window.pageYOffset;
                    var offset = 150; // Same offset as deep linking
                    
                    window.scrollTo({
                      top: Math.max(0, absoluteTop - offset),
                      behavior: 'smooth'
                    });
                  }
                  
                  // Update URL without triggering hashchange
                  history.replaceState(null, null, '#' + anchor);
                }
              });

              tocItem.appendChild(tocLink);
              tocList.appendChild(tocItem);
              header.id = anchor;

              tocItem.id = 'toc-' + level + '-' + anchor; // Unique ID based on header level
              tocItem.style.marginLeft = (level === '3') ? '1em' : (level === '4') ? '2em' : '0';
              tocItem.style.fontSize = (level === '3') ? '13px' : (level === '4') ? '12px' : 'inherit';
            }
          });
          {{ end }}

          var sidebarRight = document.querySelector('.sidebar-right');
          {{ if .Page.Params.use_jump_to_buttons }}
          // Always show sidebar when using jump buttons
          {{ else }}
          if (document.querySelectorAll('.toc-list li').length < 3) {
            sidebarRight.style.display = 'none';
          }
          {{ end }}
        });
      </script>
      {{ if not .Page.Params.use_jump_to_buttons }}
    </ul>
    {{ end }}
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const tocPanel = document.querySelector('.toc-panel');
          const header = document.querySelector('#TrueNASHeader');
          const sitenav = document.querySelector('#sitenav');
          const footer = document.querySelector('.container.gdoc-footer');
          const footerPadding = 20;
        
          function getOffsetBottom(el) {
            return el ? el.offsetTop + el.offsetHeight : 0;
          }
        
          function clampTocPanel() {
            const scrollY = window.scrollY || window.pageYOffset;
            const navHeight = sitenav ? sitenav.offsetHeight : 0;
            const tocHeight = tocPanel.offsetHeight;
            const footerTop = footer.getBoundingClientRect().top + window.scrollY - footerPadding;
        
            const tocBottom = scrollY + navHeight + tocHeight;
        
            if (scrollY > getOffsetBottom(header)) {
              tocPanel.style.position = 'fixed';
              tocPanel.style.top = navHeight + 'px'; // keep TOC below sticky menu
        
              if (tocBottom > footerTop) {
                const overlap = tocBottom - footerTop;
                tocPanel.style.top = `${navHeight - overlap}px`;
              }
            } else {
              tocPanel.style.position = 'absolute';
              tocPanel.style.top = '';
            }
          }
        
          window.addEventListener('scroll', clampTocPanel);
          window.addEventListener('resize', clampTocPanel);
          clampTocPanel();
        });        
      </script>                  
  </div>
</nav>
{{ end }}

