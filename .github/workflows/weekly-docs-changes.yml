name: Weekly Docs Changes Summary

on:
  schedule:
    - cron: '0 12 * * 1'
  workflow_dispatch: {}

jobs:
  docs-changes-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Get merged PRs from last week
        id: get-merged-prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });

            const mergedPRs = [];
            for (const pr of pulls) {
              if (!pr.merged_at) continue;

              const mergedDate = new Date(pr.merged_at);
              if (mergedDate < oneWeekAgo) continue;

              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              let category = 'updated';
              const title = pr.title.toLowerCase();
              const labels = pr.labels.map(l => l.name.toLowerCase());
              const hasNewFiles = files.some(f => f.status === 'added');

              if (hasNewFiles || title.includes('new') || title.includes('add')) {
                category = 'new';
              } else if (
                labels.includes('bug') ||
                title.includes('fix') ||
                title.includes('correct') ||
                title.includes('typo')
              ) {
                category = 'fixed';
              } else if (
                title.includes('remove') ||
                title.includes('delete') ||
                title.includes('deprecate')
              ) {
                category = 'removed';
              }

              mergedPRs.push({
                number: pr.number,
                title: pr.title,
                url: pr.html_url,
                author: pr.user.login,
                mergedAt: pr.merged_at,
                category: category,
                filesChanged: files.length,
                labels: pr.labels.map(l => l.name).join(', ')
              });
            }

            return {
              prs: mergedPRs,
              grouped: {
                new: mergedPRs.filter(pr => pr.category === 'new'),
                updated: mergedPRs.filter(pr => pr.category === 'updated'),
                fixed: mergedPRs.filter(pr => pr.category === 'fixed'),
                removed: mergedPRs.filter(pr => pr.category === 'removed')
              }
            };

      - name: Send Slack notification
        if: fromJSON(steps.get-merged-prs.outputs.result).prs.length > 0
        run: |
          RESULT='${{ steps.get-merged-prs.outputs.result }}'
          REPO_NAME="${{ github.repository }}"

          WEEK_START=$(date -d '7 days ago' +'%B %d' 2>/dev/null || date -v-7d +'%B %d')
          WEEK_END=$(date +'%B %d, %Y')

          TOTAL_PRS=$(echo "$RESULT" | jq '.prs | length')
          NEW_COUNT=$(echo "$RESULT" | jq '.grouped.new | length')
          UPDATED_COUNT=$(echo "$RESULT" | jq '.grouped.updated | length')
          FIXED_COUNT=$(echo "$RESULT" | jq '.grouped.fixed | length')
          REMOVED_COUNT=$(echo "$RESULT" | jq '.grouped.removed | length')

          SECTIONS=""

          if [ "$NEW_COUNT" -gt 0 ]; then
            NEW_ITEMS=$(echo "$RESULT" | jq -r '.grouped.new[] | "‚Ä¢ *<" + .url + "|#" + (.number|tostring) + ">* " + .title + "\\n  _by " + .author + " ‚Ä¢ " + (.filesChanged|tostring) + " files_"')
            SECTIONS="${SECTIONS}{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"‚ú® *New Content* ($NEW_COUNT)\\n$NEW_ITEMS\"}},"
          fi

          if [ "$UPDATED_COUNT" -gt 0 ]; then
            UPDATED_ITEMS=$(echo "$RESULT" | jq -r '.grouped.updated[] | "‚Ä¢ *<" + .url + "|#" + (.number|tostring) + ">* " + .title + "\\n  _by " + .author + " ‚Ä¢ " + (.filesChanged|tostring) + " files_"')
            SECTIONS="${SECTIONS}{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"üìù *Updated Content* ($UPDATED_COUNT)\\n$UPDATED_ITEMS\"}},"
          fi

          if [ "$FIXED_COUNT" -gt 0 ]; then
            FIXED_ITEMS=$(echo "$RESULT" | jq -r '.grouped.fixed[] | "‚Ä¢ *<" + .url + "|#" + (.number|tostring) + ">* " + .title + "\\n  _by " + .author + " ‚Ä¢ " + (.filesChanged|tostring) + " files_"')
            SECTIONS="${SECTIONS}{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"üêõ *Fixes* ($FIXED_COUNT)\\n$FIXED_ITEMS\"}},"
          fi

          if [ "$REMOVED_COUNT" -gt 0 ]; then
            REMOVED_ITEMS=$(echo "$RESULT" | jq -r '.grouped.removed[] | "‚Ä¢ *<" + .url + "|#" + (.number|tostring) + ">* " + .title + "\\n  _by " + .author + " ‚Ä¢ " + (.filesChanged|tostring) + " files_"')
            SECTIONS="${SECTIONS}{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"üóëÔ∏è *Removed Content* ($REMOVED_COUNT)\\n$REMOVED_ITEMS\"}},"
          fi

          SECTIONS=${SECTIONS%,}

          # FIX: QUOTED HEREDOC
          cat > slack-message.json <<'EOF'
{
  "text": "placeholder",
  "blocks": []
}
EOF

          # Replace placeholder with real JSON
          sed -i "s/placeholder/üìö Weekly Documentation Changes: $TOTAL_PRS PRs merged/" slack-message.json
          sed -i "s/\[\]/$SECTIONS/" slack-message.json

          curl -X POST -H "Content-type: application/json" \
            --data @slack-message.json \
            ${{ secrets.SLACK_WEBHOOK_URL_WEEKLY_DOCS_CHANGES }}

      - name: Send empty report if no changes
        if: fromJSON(steps.get-merged-prs.outputs.result).prs.length == 0
        run: |
          REPO_NAME="${{ github.repository }}"
          REPORT_DATE=$(date +'%B %d, %Y')

          curl -X POST -H "Content-type: application/json" \
            --data "{
              \"text\": \"üìö Weekly Documentation Changes: No changes this week\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"üìö *Weekly Documentation Changes - $REPO_NAME*\\n\\nNo PRs were merged in the last 7 days.\\n\\n_Report generated on $REPORT_DATE_\"
                  }
                }
              ]
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL_WEEKLY_DOCS_CHANGES }}
